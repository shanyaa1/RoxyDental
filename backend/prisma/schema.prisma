generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String          @id @default(uuid()) @db.Uuid
  username             String          @unique @db.VarChar(100)
  email                String          @unique @db.VarChar(255)
  passwordHash         String          @map("password_hash") @db.VarChar(255)
  role                 UserRole
  fullName             String          @map("full_name") @db.VarChar(255)
  phone                String          @db.VarChar(20)
  specialization       String?         @db.VarChar(100)
  isActive             Boolean         @default(true) @map("is_active")
  createdAt            DateTime        @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt            DateTime        @updatedAt @map("updated_at") @db.Timestamp(6)
  resetPasswordExpires DateTime?       @map("reset_password_expires") @db.Timestamp(6)
  resetPasswordToken   String?         @map("reset_password_token") @db.VarChar(255)
  education            String?         @db.VarChar(255)
  experience           String?         @db.VarChar(255)
  profilePhoto         String?         @map("profile_photo")
  sipEndDate           DateTime?       @map("sip_end_date") @db.Date
  sipNumber            String?         @map("sip_number") @db.VarChar(100)
  sipStartDate         DateTime?       @map("sip_start_date") @db.Date
  commissions          Commission[]
  financeReports       FinanceReport[] @relation("UserFinanceReports")
  leaveApprovalsGiven  LeaveRequest[]  @relation("ApproverLeaveRequests")
  leaveRequests        LeaveRequest[]  @relation("UserLeaveRequests")
  packages             Package[]       @relation("UserPackages")
  procedures           Procedure[]     @relation("UserProcedures")
  schedules            Schedule[]
  treatmentsPerformed  Treatment[]     @relation("PerformedTreatments")
  visitsAsNurse        Visit[]         @relation("NurseVisits")

  @@index([role])
  @@index([isActive])
  @@index([email])
  @@map("users")
}

model Medication {
  id           String   @id @default(uuid()) @db.Uuid
  visitId      String   @map("visit_id") @db.Uuid
  patientId    String   @map("patient_id") @db.Uuid
  name         String   @db.VarChar(255)
  quantity     String   @db.VarChar(100)
  instructions String?  @db.Text
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  
  visit   Visit   @relation(fields: [visitId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@index([patientId])
  @@map("medications")
}

model Patient {
  id                  String      @id @default(uuid()) @db.Uuid
  patientNumber       String      @unique @map("patient_number") @db.VarChar(50)
  fullName            String      @map("full_name") @db.VarChar(255)
  dateOfBirth         DateTime    @map("date_of_birth") @db.Date
  gender              Gender
  phone               String      @db.VarChar(20)
  email               String?     @db.VarChar(255)
  address             String?
  bloodType           String?     @map("blood_type") @db.VarChar(5)
  allergies           String?
  medicalHistory      String?     @map("medical_history")
  createdAt           DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt           DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)
  medicalRecordNumber String?     @unique @map("medical_record_number") @db.VarChar(50)
  treatments          Treatment[]
  visits              Visit[]
  medications         Medication[]

  @@index([patientNumber])
  @@index([fullName])
  @@index([phone])
  @@map("patients")
}

model Service {
  id              String          @id @default(uuid()) @db.Uuid
  serviceCode     String          @unique @map("service_code") @db.VarChar(50)
  serviceName     String          @map("service_name") @db.VarChar(255)
  category        ServiceCategory
  description     String?
  basePrice       Decimal         @map("base_price") @db.Decimal(12, 2)
  commissionRate  Decimal         @map("commission_rate") @db.Decimal(5, 2)
  durationMinutes Int?            @map("duration_minutes")
  isActive        Boolean         @default(true) @map("is_active")
  createdAt       DateTime        @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime        @default(now()) @updatedAt @map("updated_at") @db.Timestamp(6)
  treatments      Treatment[]

  @@index([category])
  @@index([isActive])
  @@index([serviceCode])
  @@map("services")
}

model FinanceReport {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  tipe          String   @db.VarChar(100)
  nama          String   @db.VarChar(255)
  prosedur      String?  @db.VarChar(255)
  potongan      Decimal  @default(0) @db.Decimal(12, 2)
  bhpHarga      Decimal  @default(0) @map("bhp_harga") @db.Decimal(12, 2)
  bhpKomisi     Decimal  @default(0) @map("bhp_komisi") @db.Decimal(5, 2)
  farmasiHarga  Decimal  @default(0) @map("farmasi_harga") @db.Decimal(12, 2)
  farmasiKomisi Decimal  @default(0) @map("farmasi_komisi") @db.Decimal(5, 2)
  paketHarga    Decimal  @default(0) @map("paket_harga") @db.Decimal(12, 2)
  paketKomisi   Decimal  @default(0) @map("paket_komisi") @db.Decimal(5, 2)
  labHarga      Decimal  @default(0) @map("lab_harga") @db.Decimal(12, 2)
  labKomisi     Decimal  @default(0) @map("lab_komisi") @db.Decimal(5, 2)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  user          User     @relation("UserFinanceReports", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([nama])
  @@map("finance_reports")
}

model Procedure {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  name      String   @db.VarChar(255)
  code      String   @unique @db.VarChar(50)
  quantity  Int      @default(1)
  salePrice Decimal  @map("sale_price") @db.Decimal(12, 2)
  avgComm   Decimal  @default(0) @map("avg_comm") @db.Decimal(5, 2)
  totalSale Decimal  @map("total_sale") @db.Decimal(12, 2)
  totalComm Decimal  @map("total_comm") @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  user      User     @relation("UserProcedures", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([name])
  @@index([code])
  @@map("procedures")
}

model Package {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  name      String   @db.VarChar(255)
  sku       String   @unique @db.VarChar(50)
  quantity  Int      @default(1)
  salePrice Decimal  @map("sale_price") @db.Decimal(12, 2)
  avgComm   Decimal  @default(0) @map("avg_comm") @db.Decimal(5, 2)
  totalSale Decimal  @map("total_sale") @db.Decimal(12, 2)
  totalComm Decimal  @map("total_comm") @db.Decimal(12, 2)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamp(6)
  user      User     @relation("UserPackages", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([name])
  @@index([sku])
  @@map("packages")
}

model Visit {
  id             String      @id @default(uuid()) @db.Uuid
  patientId      String      @map("patient_id") @db.Uuid
  nurseId        String      @map("nurse_id") @db.Uuid
  visitNumber    String      @unique @map("visit_number") @db.VarChar(50)
  visitDate      DateTime    @map("visit_date") @db.Timestamp(6)
  queueNumber    Int         @map("queue_number")
  status         VisitStatus @default(WAITING)
  chiefComplaint String?     @map("chief_complaint")
  bloodPressure  String?     @map("blood_pressure") @db.VarChar(20)
  notes          String?
  totalCost      Decimal     @default(0) @map("total_cost") @db.Decimal(12, 2)
  createdAt      DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)
  payments       Payment[]
  treatments     Treatment[]
  medications    Medication[]
  nurse          User        @relation("NurseVisits", fields: [nurseId], references: [id])
  patient        Patient     @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId])
  @@index([nurseId])
  @@index([visitDate])
  @@index([status])
  @@index([queueNumber])
  @@map("visits")
}

model Treatment {
  id             String       @id @default(uuid()) @db.Uuid
  visitId        String       @map("visit_id") @db.Uuid
  patientId      String       @map("patient_id") @db.Uuid
  serviceId      String       @map("service_id") @db.Uuid
  performedBy    String       @map("performed_by") @db.Uuid
  toothNumber    String?      @map("tooth_number") @db.VarChar(10)
  diagnosis      String?
  treatmentNotes String?      @map("treatment_notes")
  quantity       Int          @default(1)
  unitPrice      Decimal      @map("unit_price") @db.Decimal(12, 2)
  discount       Decimal      @default(0) @db.Decimal(12, 2)
  subtotal       Decimal      @map("subtotal") @db.Decimal(12, 2)
  images         String[]
  createdAt      DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt      DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)
  commissions    Commission[]
  patient        Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  performer      User         @relation("PerformedTreatments", fields: [performedBy], references: [id])
  service        Service      @relation(fields: [serviceId], references: [id])
  visit          Visit        @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@index([patientId])
  @@index([serviceId])
  @@index([performedBy])
  @@index([createdAt])
  @@map("treatments")
}

model Payment {
  id              String        @id @default(uuid()) @db.Uuid
  visitId         String        @map("visit_id") @db.Uuid
  paymentNumber   String        @unique @map("payment_number") @db.VarChar(50)
  paymentDate     DateTime      @map("payment_date") @db.Timestamp(6)
  paymentMethod   PaymentMethod @map("payment_method")
  amount          Decimal       @db.Decimal(12, 2)
  paidAmount      Decimal       @map("paid_amount") @db.Decimal(12, 2)
  changeAmount    Decimal       @default(0) @map("change_amount") @db.Decimal(12, 2)
  status          PaymentStatus @default(PENDING)
  referenceNumber String?       @map("reference_number") @db.VarChar(100)
  notes           String?
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamp(6)
  visit           Visit         @relation(fields: [visitId], references: [id], onDelete: Cascade)

  @@index([visitId])
  @@index([paymentDate])
  @@index([status])
  @@index([paymentNumber])
  @@map("payments")
}

model Schedule {
  id                String       @id @default(uuid()) @db.Uuid
  userId            String       @map("user_id") @db.Uuid
  title             String       @db.VarChar(255)
  description       String?
  scheduleType      ScheduleType @map("schedule_type")
  startDatetime     DateTime     @map("start_datetime") @db.Timestamp(6)
  endDatetime       DateTime     @map("end_datetime") @db.Timestamp(6)
  location          String?      @db.VarChar(255)
  isRecurring       Boolean      @default(false) @map("is_recurring")
  recurrencePattern String?      @map("recurrence_pattern") @db.VarChar(100)
  createdAt         DateTime     @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt         DateTime     @updatedAt @map("updated_at") @db.Timestamp(6)
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([startDatetime])
  @@index([scheduleType])
  @@map("schedules")
}

model LeaveRequest {
  id              String      @id @default(uuid()) @db.Uuid
  userId          String      @map("user_id") @db.Uuid
  approvedBy      String?     @map("approved_by") @db.Uuid
  startDate       DateTime    @map("start_date") @db.Date
  endDate         DateTime    @map("end_date") @db.Date
  leaveType       LeaveType   @map("leave_type")
  reason          String
  status          LeaveStatus @default(PENDING)
  rejectionReason String?     @map("rejection_reason")
  approvedAt      DateTime?   @map("approved_at") @db.Timestamp(6)
  createdAt       DateTime    @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt       DateTime    @updatedAt @map("updated_at") @db.Timestamp(6)
  approver        User?       @relation("ApproverLeaveRequests", fields: [approvedBy], references: [id])
  requester       User        @relation("UserLeaveRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([approvedBy])
  @@index([status])
  @@index([startDate])
  @@map("leave_requests")
}

model Commission {
  id               String           @id @default(uuid()) @db.Uuid
  userId           String           @map("user_id") @db.Uuid
  treatmentId      String           @map("treatment_id") @db.Uuid
  baseAmount       Decimal          @map("base_amount") @db.Decimal(12, 2)
  commissionRate   Decimal          @map("commission_rate") @db.Decimal(5, 2)
  commissionAmount Decimal          @map("commission_amount") @db.Decimal(12, 2)
  periodMonth      Int              @map("period_month")
  periodYear       Int              @map("period_year")
  status           CommissionStatus @default(PENDING)
  paidAt           DateTime?        @map("paid_at") @db.Timestamp(6)
  notes            String?
  createdAt        DateTime         @default(now()) @map("created_at") @db.Timestamp(6)
  treatment        Treatment        @relation(fields: [treatmentId], references: [id], onDelete: Cascade)
  user             User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([treatmentId])
  @@index([periodMonth, periodYear])
  @@index([status])
  @@map("commissions")
}

enum UserRole {
  DOKTER
  PERAWAT
}

enum Gender {
  L
  P
}

enum VisitStatus {
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum ServiceCategory {
  CONSULTATION
  SCALING
  FILLING
  EXTRACTION
  WHITENING
  ORTHODONTIC
  OTHER
}

enum ScheduleType {
  SHIFT
  MEETING
  ACTIVITY
}

enum LeaveType {
  SICK
  ANNUAL
  EMERGENCY
  UNPAID
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PaymentMethod {
  CASH
  TRANSFER
  CARD
  QRIS
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  REFUNDED
}

enum CommissionStatus {
  PENDING
  PAID
}
